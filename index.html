<html lang="en" class="overflow-x-hidden">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Siasat - Sistem Antrian Satker</title>
    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/album/">

    <!-- Bootstrap core CSS -->
    <link href="assets/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<style>
      body {
        overflow-x: hidden;
      }

      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      .logo {
        height: 50px;
      }

      .listku {
        height: 70vh;
      }
    </style>

    
  </head>
  <body>
    
<header class="overflow-hidden">
  <div class="navbar navbar-dark bg-dark shadow-sm">
    <div class="container">
      <a href="#" class="navbar-brand d-flex align-items-center">
        <img class="logo mx-2" src="assets/img/logo-kemhan.png">
        <strong>SIASAT | Sistem Antrian Satker</strong>
      </a>
    </div>
  </div>
</header>

<main>

  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3" id="DivIdToPrint">
    <div class="col-md-8 col-sm-12">
      <section class="py-3 container">
        <!-- form input -->
        <div class="mb-3">
          <label for="nama" class="form-label">INPUT FORM</label>
          <input type="text" class="form-control mb-2" id="nama" placeholder="Nama Pengunjung">
          <input type="text" class="form-control" id="judul" placeholder="Judul">
        </div>
        <!-- satker -->
        <div class="mb-3">
          <label for="formGroupExampleInput" class="form-label">SUB SATKER</label>
          <div class="row">
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="satker" id="satker1" value="Sekretariat" checked>
                <label class="form-check-label" for="satker1">Sekretariat</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="satker" id="satker2" value="Pusintelhan">
                <label class="form-check-label" for="satker2">Pusintelhan</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="satker" id="satker3" value="Pusduk">
                <label class="form-check-label" for="satker3">Pusduk</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="satker" id="satker4" value="Pussiber">
                <label class="form-check-label" for="satker4">Pussiber</label>
              </div>
            </div>
          </div>
        </div>
        <!-- nomor fd -->
        <div class="mb-3">
          <label for="formGroupExampleInput" class="form-label">NOMOR FD</label>
          <div class="row">
            <div class="col-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="toggle-fd" checked>
                <label class="form-check-label" for="toggle-fd">Otomatis/Manual</label>
              </div>
            </div>
            <div class="col-6">
              <input type="number" class="form-control" id="no-fd" min="1" disabled>
            </div>
          </div>
        </div>
         <!-- jumlah fd -->
        <div class="mb-3">
          <div class="row">
            <div class="col-6">
              <label for="formGroupExampleInput" class="form-label">JUMLAH NOMOR FD</label>
            </div>
            <div class="col-6">
              <input type="number" class="form-control" id="jumlah" value="1" min="1">
            </div>
          </div>
        </div>
        <!-- durasi -->
        <div class="mb-3">
          <div class="row">
            <div class="col-6">
              <label for="formGroupExampleInput" class="form-label">DURASI (HARI)</label>
            </div>
            <div class="col-6">
              <input type="number" class="form-control" id="durasi" value="1" min="1">
            </div>
          </div>
        </div>
        <!-- cetak antrian -->
        <div class="mb-3 text-center">
          <button type="button" class="btn btn-primary" id="btn-cetak">Cetak Antrian</button>
        </div>

      </section>
    </div>

    <!-- list mulai -->
    <div class="col-md-4 col-sm-12">
      <div class="py-3 bg-light">
        <div class="container">
          <h5 class="text-center">RIWAYAT STRUK</h5>
          <div class="text-center"><button type="button" class="btn btn-danger mb-3" id="hapus-riwayat">Hapus Semua Riwayat</button></div> 
          <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 mb-5 overflow-auto listku border pt-2" id="preview">
            <!-- looping mulai -->
            <!-- <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-header text-center">
                  <b>Mock Struk</b>
                </div>
                <div class="card-body">
                  <p class="card-text">
                      No. FD  :                   <br>
                      Nama    :                   <br>
                      Tujuan  :                   <br>
                      Durasi  :                   <br>
                  </p>
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="btn-group">
                      <button type="button" class="btn btn-sm btn-outline-secondary">Hapus</button>
                      <button type="button" class="btn btn-sm btn-outline-secondary">Print</button>
                    </div>
                  </div>
                </div>
              </div>
            </div> -->
            <!-- looping selesai -->
                        
          </div>
        </div>

      </div>
    </div>
    <!-- list selesai -->

  </div>

</main>

<!-- <footer class="text-muted py-5">
  <div class="container">
    <p class="float-end mb-1">
      <a href="#">Back to top</a>
    </p>
    <p class="mb-1">Album example is &copy; Bootstrap, but please download and customize it for yourself!</p>
    <p class="mb-0">New to Bootstrap? <a href="/">Visit the homepage</a> or read our <a href="../getting-started/introduction/">getting started guide</a>.</p>
  </div>
</footer> -->


    <!-- <script src="../assets/dist/js/bootstrap.bundle.min.js"></script> -->
    <!-- <script type="text/javascript" src="database.json"></script> -->
    <script>
      $(document).ready(function() {
          console.log('Siap bung!');

          read();
          
          // tambah antrian
          $('#btn-cetak').click(function (e) { 
            let id = $('#no-fd').val();
            let nama = $('#nama').val();
            let judul = $('#judul').val();
            let satker = $('input[name="satker"]:checked').val();
            let isOto = $('input[id="toggle-fd"]:checked').val();
            let durasi = $('#durasi').val();
            let jumlah = $('#jumlah').val();

            if(nama == ''){
              alert('Nama belum diisi')
            } else {
              let kirim = {id:id, nama:nama, judul:judul, satker:satker, isOto:isOto, durasi:durasi, jumlah:jumlah};
              tambah(kirim);
            }

            console.log('btn-cetak:', nama, satker, id, isOto, durasi);
          });

          // fd toggle
          $('#toggle-fd').change(function (e) { 
            if(this.checked){
              console.log('checked');
              $('#no-fd').attr('disabled', '');
            } else {
              console.log('no checked');
              $('#no-fd').removeAttr('disabled');
            }
          });

          $('#hapus-riwayat').click(function (e) { 
            write(JSON.parse('[]'));
          });

          
      });

      let urlRead = 'https://towingkalimantan.com/api/siasat/read';

      function tambah(data) {
        $.ajax({
          type: 'get',
          url: urlRead,
          success: function (response) {
            let read = JSON.parse(response);
            read.push(data);
            write(read);
          }
        });
      }

      function read() {
        $.ajax({
          type: 'get',
          url: urlRead,
          success: function (response) {
            let read = JSON.parse(response);
            console.log("read:", read);
            
            if(read.length == 0){
              $('#preview').append('<div class="w-100 text-center">Riwayat Kosong</div>');
            }            

            // otomatis no fd
            const maxId = read.reduce((max, currentItem) => {
              return Math.max(max, currentItem.id);
            }, 0);
            console.log('maxId', maxId);

            let maxJml = 0;
            for (const item in read) {
                if(maxId == read[item].id){
                  maxJml = read[item].jumlah - 1;
                  console.log('maxJml', maxJml);
                }
            }

            $('#no-fd').val(maxId+1+maxJml);

            // show list preview
            for(let i = read.length-1; i > -1; i--) {
              let item = read[i];
              // console.log(item, read[item]);

              let jml = Number(item.jumlah);
              let sampai = '';
              if(jml > 1){
                sampai = ' Sampai ' + (Number(item.id) + jml - 1);
              }
              console.log('jml', jml, 'sampai', sampai);

              let loopMock = '<div class="col-12 mb-2 item-loop"><div class="card shadow-sm"><div class="card-header text-center">';
              loopMock += '<b>Mock Struk</b></div><div class="card-body"><p class="card-text" jumlah-fd="'+item.jumlah+'">';
              loopMock += 'No. FD  : <a class="text-decoration-none text-dark data-no-fd">'+item.id+'</a> '+sampai+'<br>';
              loopMock += 'Nama    : <a class="text-decoration-none text-dark data-nama">'+item.nama+'</a> <br>';
              loopMock += 'Judul    : <a class="text-decoration-none text-dark data-judul">'+item.judul+'</a> <br>';
              loopMock += 'Tujuan  : <a class="text-decoration-none text-dark data-satker">'+item.satker+'</a> <br>';
              loopMock += 'Durasi  : <a class="text-decoration-none text-dark data-durasi">'+item.durasi+'</a> hari<br>';
              loopMock += 'Jumlah FD  : <a class="text-decoration-none text-dark data-jumlah">'+item.jumlah+'</a> <br>';
              loopMock += '</p><div class="d-flex justify-content-between align-items-center"><div class="btn-group">';
              // loopMock += '<button type="button" class="btn btn-sm btn-outline-secondary">Hapus</button>';
              loopMock += '<button type="button" class="btn btn-sm btn-outline-secondary" onclick="printDiv(this);">Print</button></div></div></div></div></div>';
              $('#preview').append(loopMock);

            }
          }
        });
      }

      function write(data) {
        console.log('write', data);
        $.ajax({
          type: 'post',
          data: {data:JSON.stringify(data)},
          url: 'https://towingkalimantan.com/api/siasat/write',
          success: function (response) {
            console.log(response);
            window.location.reload();
          }
        });
      }

      // print antrian
      function printDiv(data){
        let divToPrint= data.closest('.card-body').querySelector('.card-text');
        let jumlahSize = divToPrint.getAttribute('jumlah-fd');
        let id = $(divToPrint).find('.data-no-fd').text().trim();
        let nama = $(divToPrint).find('.data-nama').text().trim();
        let judul = $(divToPrint).find('.data-judul').text().trim();
        let satker = $(divToPrint).find('.data-satker').text().trim();
        let durasi = $(divToPrint).find('.data-durasi').text().trim();
        let jumlah = $(divToPrint).find('.data-jumlah').text().trim();
        console.log('id', id, 'nama', nama, 'judul', judul, 'satker', satker, 'durasi', durasi, 'jumlah', jumlah, 'jumlahSize', jumlahSize);

        let content = '';
        let count = 0;
        for (let i = 0; i < jumlahSize; i++) {
          let conData = 'No. FD  : <a class="text-decoration-none text-dark data-no-fd">'+( Number(id) + count) +'</a> <br>'
          + 'Nama    : <a class="text-decoration-none text-dark data-nama">'+nama+'</a> <br>'
          + 'Judul    : <a class="text-decoration-none text-dark data-judul">'+judul+'</a> <br>'
          + 'Tujuan  : <a class="text-decoration-none text-dark data-satker">'+satker+'</a> <br>'
          + 'Durasi  : <a class="text-decoration-none text-dark data-durasi">'+durasi+'</a> hari<br>'
          + 'Jumlah FD  : <a class="text-decoration-none text-dark data-jumlah">'+jumlah+'</a> <br>';

            content += '<div style="border-style: solid; padding:20px 20px 20px 20px; margin:0px 10 10px 0; width:49%; display:inline-block; box-sizing: border-box;"> <b>Mock Struk Admin</b> <hr>'+ conData + '</div>'
          + '<div style="border-style: solid; padding:20px 20px 20px 20px; margin:0px 0 10px 0; width:49%; display:inline-block; box-sizing: border-box;"> <b>Mock Struk Klien</b> <hr>'+ conData +'</div>';

          count += 1;
        }

        var newWin=window.open('','Print-Window');
        newWin.document.open();
        newWin.document.write('<html><body onload="window.print()">' + content + '</body></html>');
        newWin.document.close();
        setTimeout(function(){newWin.close();},10);
      }


      // function printDiv(data){
      //   var divToPrint= data.closest('.card-body').querySelector('.card-text');
      //   var jumlah = divToPrint.getAttribute('jumlah-fd');
      //   console.log('divToPrint', divToPrint, 'jumlah', jumlah);

      //   let content = '';
      //   for (let i = 0; i < jumlah; i++) {
      //       content += '<div style="border-style: solid; padding:20px 20px 20px 20px; margin:0px 100px 10px 100px"> <b>Mock Struk Admin</b> <hr>'+ divToPrint.innerHTML + '</div>'
      //     + '<div style="border-style: solid; padding:20px 20px 20px 20px; margin:0px 100px 0px 100px"> <b>Mock Struk Klien</b> <hr>'+ divToPrint.innerHTML+'</div>';
          
      //     let contentHTML = $($.parseHTML(content)).find('fdLoop');

      //     console.log('content', contentHTML);
      //   }

      //   var newWin=window.open('','Print-Window');
      //   newWin.document.open();
      //   newWin.document.write('<html><body onload="window.print()">' + content + '</body></html>');
      //   newWin.document.close();
      //   setTimeout(function(){newWin.close();},10);
      // }
    </script>
  </body>
</html>
